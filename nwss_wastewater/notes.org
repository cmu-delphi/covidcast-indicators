#+title: Notes
* General todos
** WAIT for the metric data, figure out whether to use the start, middle, or end date.
* Setup
#+begin_src jupyter-python :session *nwss
import numpy as np
import os
import pandas as pd
from sodapy import Socrata
token = os.environ.get("SODAPY_APPTOKEN")
client = Socrata("data.cdc.gov", token)
results = client.get("g653-rqe2", limit=10**10)

df = pd.DataFrame.from_records(results)
df.transpose()
client = Socrata("data.cdc.gov", token)
results_metric = client.get("2ew6-ywp6", limit=10**10)

df_metric = pd.DataFrame.from_records(results_metric)
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
df_metric.wwtp_id = pd.to_numeric(df_metric.wwtp_id)
df_metric.population_served = pd.to_numeric(df_metric.population_served)
df_metric.detect_prop_15d = pd.to_numeric(df_metric.detect_prop_15d)
df_metric.percentile = pd.to_numeric(df_metric.percentile)
df_metric.ptc_15d = pd.to_numeric(df_metric.ptc_15d)
df_metric.sample_location_specify = pd.to_numeric(df_metric.sample_location_specify)
df_metric.iloc[0,:].transpose()
#+end_src

#+RESULTS:
#+begin_example
wwtp_jurisdiction                                                   Arkansas
wwtp_id                                                                 1548
reporting_jurisdiction                                              Arkansas
sample_location                                              Treatment plant
key_plot_id                CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                       Jefferson
county_fips                                                            05069
population_served                                                      42323
date_start                                                        2023-06-11
date_end                                                          2023-06-25
detect_prop_15d                                                        100.0
percentile                                                              10.0
sampling_prior                                                            no
first_sample_date                                                 2023-06-25
ptc_15d                                                                  NaN
sample_location_specify                                                  NaN
Name: 0, dtype: object
#+end_example

+The metric data actually doesn't contain the standard error information, so it's triply dubious for us...+ neither contains the error, even though its described in the [[https://www.cdc.gov/nwss/reporting.html][reporting Data dictionary]]

#+begin_src jupyter-python :session *nwss
df_metric.detect_prop_15d.unique()
#+end_src

#+RESULTS:
: array([100.,  nan,  80.,  75.,  67.,  33.,  50.,  60.,  40.,  25.,  20.,
:          0.,  83.,  86.,  88.,  17.,  14.,  13.,  11.,  22.,  38.,  44.,
:         56.,  30.,  63.,  78.,  89.,  90.,  71.,  57.,  43.,  10.,   9.,
:         29.,  18.,  27.,  82.,  15.,  21.,  23.,  31.,  46.,  54.,  62.,
:         69.,  58.,  79.,  73.,  64.,  53.,  47.,  87.,  93.,  36.,  92.,
:         91.,  70.,  45.,  55.,  85.,  77.,  42.])

* Examining the Keys
** =wwtp_jurisdiction=
#+begin_quote
State, DC, US territory, or Freely Associated State jurisdiction name (2-letter abbreviation) in which the wastewater treatment plant provided in 'wwtp_id' is located.
#+end_quote
first, looking to see what the values of =wwtp_jurisdiction= actually are:
#+begin_src jupyter-python :session *nwss
wwtp_jur = df_metric.wwtp_jurisdiction.unique()
wwtp_jur.sort()
wwtp_jur
#+end_src

#+RESULTS:
#+begin_example
    array(['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
       'Colorado', 'Connecticut', 'Delaware', 'District of Columbia',
       'Florida', 'Georgia', 'Guam', 'Hawaii', 'Idaho', 'Illinois',
       'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine',
       'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
       'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada',
       'New Hampshire', 'New Jersey', 'New Mexico', 'New York',
       'New York City', 'North Carolina', 'North Dakota', 'Ohio',
       'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island',
       'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah',
       'Vermont', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin',
       'Wyoming'], dtype=object)
#+end_example
53 entries: 50 states, DC Guam, and NYC
** =wwtp_id=
#+begin_quote
A unique identifier for wastewater treatment plants. This is an arbitrary integer used to provide a unique, but anonymous identifier for a wastewater treatment plant. This identifier is consistent over time, such that the same plant retains the same ID regardless of the addition or subtraction of other plants from the data set.
#+end_quote
Not too much to say here, there are
WRONG. These are not unique overall
#+begin_src jupyter-python :session *nwss
df_metric[df_metric.wwtp_id == 82]
#+end_src

#+RESULTS:
#+begin_example
       wwtp_jurisdiction  wwtp_id reporting_jurisdiction  sample_location                                key_plot_id county_names county_fips  population_served  date_start    date_end  detect_prop_15d  percentile sampling_prior first_sample_date  ptc_15d  sample_location_specify
430964          Missouri       82               Missouri  Treatment plant  NWSS_mo_82_Treatment plant_raw wastewater      Carroll       29033               3784  2020-06-23  2020-07-07            100.0         NaN            yes        2020-07-07      NaN                      NaN
430965          Missouri       82               Missouri  Treatment plant  NWSS_mo_82_Treatment plant_raw wastewater      Carroll       29033               3784  2020-06-24  2020-07-08            100.0         NaN            yes        2020-07-07      NaN                      NaN
430966          Missouri       82               Missouri  Treatment plant  NWSS_mo_82_Treatment plant_raw wastewater      Carroll       29033               3784  2020-06-25  2020-07-09            100.0         NaN            yes        2020-07-07      NaN                      NaN
430967          Missouri       82               Missouri  Treatment plant  NWSS_mo_82_Treatment plant_raw wastewater      Carroll       29033               3784  2020-06-26  2020-07-10            100.0         NaN            yes        2020-07-07      NaN                      NaN
430968          Missouri       82               Missouri  Treatment plant  NWSS_mo_82_Treatment plant_raw wastewater      Carroll       29033               3784  2020-06-27  2020-07-11            100.0         NaN            yes        2020-07-07      NaN                      NaN
...                  ...      ...                    ...              ...                                        ...          ...         ...                ...         ...         ...              ...         ...            ...               ...      ...                      ...
577584              Ohio       82                   Ohio  Treatment plant  NWSS_oh_82_Treatment plant_raw wastewater      Carroll       39019               3500  2023-09-28  2023-10-12             67.0       999.0             no        2023-09-18   -100.0                      NaN
577585              Ohio       82                   Ohio  Treatment plant  NWSS_oh_82_Treatment plant_raw wastewater      Carroll       39019               3500  2023-09-29  2023-10-13             67.0       999.0             no        2023-09-18   -100.0                      NaN
577586              Ohio       82                   Ohio  Treatment plant  NWSS_oh_82_Treatment plant_raw wastewater      Carroll       39019               3500  2023-09-30  2023-10-14             67.0       999.0             no        2023-09-18   -100.0                      NaN
577587              Ohio       82                   Ohio  Treatment plant  NWSS_oh_82_Treatment plant_raw wastewater      Carroll       39019               3500  2023-10-01  2023-10-15             67.0       999.0             no        2023-09-18   -100.0                      NaN
577588              Ohio       82                   Ohio  Treatment plant  NWSS_oh_82_Treatment plant_raw wastewater      Carroll       39019               3500  2023-10-02  2023-10-16             67.0       999.0             no        2023-09-18   -100.0                      NaN

[1226 rows x 16 columns]
#+end_example
these are emphatically not plant unique, unless wastewater is being piped from Ohio down to Missouri.
** =reporting_jurisidiction=
#+begin_src jupyter-python :session *nwss
reporters = df_metric.reporting_jurisdiction.unique()
reporters.sort()
len(reporters)
#+end_src

#+RESULTS:
: 55
These aren't quite the same as the wwtp jurisdictions...
#+begin_src jupyter-python :session *nwss
np.setdiff1d(reporters, wwtp_jur)
#+end_src

#+RESULTS:
: array(['Chicago', 'Houston'], dtype=object)

and what of chicago? Its reported in Illinois

#+begin_src jupyter-python :session *nwss
df_metric[df_metric.reporting_jurisdiction == "Chicago"].transpose()
#+end_src

#+RESULTS:
#+begin_example
                                                                    3549    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-07   
date_end                                                        2023-03-21   
detect_prop_15d                                                        100   
percentile                                                            84.0   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                NaN   
sample_location_specify                                                 21   

                                                                    3550    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-08   
date_end                                                        2023-03-22   
detect_prop_15d                                                        100   
percentile                                                            84.0   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                NaN   
sample_location_specify                                                 21   

                                                                    3551    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-09   
date_end                                                        2023-03-23   
detect_prop_15d                                                        100   
percentile                                                            74.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                -32   
sample_location_specify                                                 21   

                                                                    3552    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-10   
date_end                                                        2023-03-24   
detect_prop_15d                                                        100   
percentile                                                            74.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                -32   
sample_location_specify                                                 21   

                                                                    3553    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-11   
date_end                                                        2023-03-25   
detect_prop_15d                                                        100   
percentile                                                            74.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                -32   
sample_location_specify                                                 21   

                                                                    3554    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-12   
date_end                                                        2023-03-26   
detect_prop_15d                                                        100   
percentile                                                            74.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                -32   
sample_location_specify                                                 21   

                                                                    3555    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-13   
date_end                                                        2023-03-27   
detect_prop_15d                                                        100   
percentile                                                            74.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                -32   
sample_location_specify                                                 21   

                                                                    3556    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-14   
date_end                                                        2023-03-28   
detect_prop_15d                                                        100   
percentile                                                          82.333   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                 70   
sample_location_specify                                                 21   

                                                                    3557    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-15   
date_end                                                        2023-03-29   
detect_prop_15d                                                        100   
percentile                                                          82.333   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                 70   
sample_location_specify                                                 21   

                                                                    3558    \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                675   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_675_Before treatment plant_21_raw wast...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                    24099   
date_start                                                      2023-03-16   
date_end                                                        2023-03-30   
detect_prop_15d                                                        100   
percentile                                                            78.5   
sampling_prior                                                          no   
first_sample_date                                               2023-03-21   
ptc_15d                                                                 17   
sample_location_specify                                                 21   

                         ...  \
wwtp_jurisdiction        ...   
wwtp_id                  ...   
reporting_jurisdiction   ...   
sample_location          ...   
key_plot_id              ...   
county_names             ...   
county_fips              ...   
population_served        ...   
date_start               ...   
date_end                 ...   
detect_prop_15d          ...   
percentile               ...   
sampling_prior           ...   
first_sample_date        ...   
ptc_15d                  ...   
sample_location_specify  ...   

                                                                    516924  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-18   
date_end                                                        2023-10-02   
detect_prop_15d                                                        100   
percentile                                                            68.8   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 10   
sample_location_specify                                                489   

                                                                    516925  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-19   
date_end                                                        2023-10-03   
detect_prop_15d                                                        100   
percentile                                                            68.8   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                  4   
sample_location_specify                                                489   

                                                                    516926  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-20   
date_end                                                        2023-10-04   
detect_prop_15d                                                        100   
percentile                                                            67.4   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                  5   
sample_location_specify                                                489   

                                                                    516927  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-21   
date_end                                                        2023-10-05   
detect_prop_15d                                                        100   
percentile                                                            67.4   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 30   
sample_location_specify                                                489   

                                                                    516928  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-22   
date_end                                                        2023-10-06   
detect_prop_15d                                                        100   
percentile                                                            67.4   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 30   
sample_location_specify                                                489   

                                                                    516929  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-23   
date_end                                                        2023-10-07   
detect_prop_15d                                                        100   
percentile                                                            67.4   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 30   
sample_location_specify                                                489   

                                                                    516930  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-24   
date_end                                                        2023-10-08   
detect_prop_15d                                                        100   
percentile                                                            67.4   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 30   
sample_location_specify                                                489   

                                                                    516931  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-25   
date_end                                                        2023-10-09   
detect_prop_15d                                                        100   
percentile                                                            67.8   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                  4   
sample_location_specify                                                489   

                                                                    516932  \
wwtp_jurisdiction                                                 Illinois   
wwtp_id                                                                635   
reporting_jurisdiction                                             Chicago   
sample_location                                     Before treatment plant   
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...   
county_names                                                          Cook   
county_fips                                                          17031   
population_served                                                   125995   
date_start                                                      2023-09-26   
date_end                                                        2023-10-10   
detect_prop_15d                                                        100   
percentile                                                            67.8   
sampling_prior                                                          no   
first_sample_date                                               2023-05-03   
ptc_15d                                                                 -8   
sample_location_specify                                                489   

                                                                    516933  
wwtp_jurisdiction                                                 Illinois  
wwtp_id                                                                635  
reporting_jurisdiction                                             Chicago  
sample_location                                     Before treatment plant  
key_plot_id              NWSS_il_635_Before treatment plant_489_raw was...  
county_names                                                          Cook  
county_fips                                                          17031  
population_served                                                   125995  
date_start                                                      2023-09-27  
date_end                                                        2023-10-11  
detect_prop_15d                                                        100  
percentile                                                            67.8  
sampling_prior                                                          no  
first_sample_date                                               2023-05-03  
ptc_15d                                                                 -8  
sample_location_specify                                                489  

[16 rows x 3179 columns]
#+end_example


#+begin_quote
The CDC Epidemiology and Laboratory Capacity (ELC) jurisdiction, most frequently a state, reporting these data (2-letter abbreviation)
#+end_quote
** =key_plot_id=
#+begin_src jupyter-python :session *nwss
len(df_metric.key_plot_id.unique())
#+end_src

#+RESULTS:
: 1735
#+begin_src jupyter-python :session *nwss
df_metric.key_plot_id.unique()
#+end_src

#+RESULTS:
: array(['CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater',
:        'CDC_BIOBOT_in_1162_Treatment plant_raw wastewater',
:        'NWSS_il_675_Before treatment plant_21_raw wastewater', ...,
:        'NWSS_ny_1404_Treatment plant_raw wastewater',
:        'NWSS_wa_2105_Treatment plant_raw wastewater',
:        'WWS_ca_1703_Treatment plant_post grit removal'], dtype=object)
*** Is it unique per-geo?
#+begin_src jupyter-python :session *nwss
df_metric.set_index(["date_start", "key_plot_id"]).index.duplicated().sum()
#df_metric.columns
#+end_src

#+RESULTS:
: 0

Yes! for metric
#+begin_src jupyter-python :session *nwss
df.set_index(["date", "key_plot_id"]).index.duplicated().sum()
#df_metric.columns
#+end_src

#+RESULTS:
: 0
Also yes, apparently(?)
#+begin_src jupyter-python :session *nwss
df.groupby(["date", "key_plot_id"]).agg({"normalization" : "nunique"}).sort_values("normalization")
#+end_src

#+RESULTS:
#+begin_example
                                                               normalization
date       key_plot_id
2020-04-22 NWSS_az_1212_Before treatment plant_92_raw wast...              0
2023-06-18 NWSS_fl_1735_Treatment plant_raw wastewater                     0
           CDC_BIOBOT_wy_188_Treatment plant_raw wastewater                0
           CDC_BIOBOT_wy_1317_Treatment plant_post grit re...              0
           CDC_BIOBOT_wa_661_Treatment plant_raw wastewater                0
...                                                                      ...
2022-09-24 NWSS_tx_35_Treatment plant_raw wastewater                       1
           NWSS_tx_366_Treatment plant_raw wastewater                      1
           NWSS_tx_367_Treatment plant_raw wastewater                      1
           NWSS_tx_287_Treatment plant_raw wastewater                      1
2023-02-03 NWSS_co_1592_Treatment plant_raw wastewater                     1

[711676 rows x 1 columns]
#+end_example
yes definitely. there are no sites which use different normalizations for the same level of processing

** =population_served=
#+begin_src jupyter-python :session *nwss
df_metric.population_served.unique()
#+end_src

#+RESULTS:
: array(['42323', '98000', '24099', ..., '10890', '24180', '53000'],
:       dtype=object)
Are any of the populations NaNs?
#+begin_src jupyter-python :session *nwss
df_metric.population_served.astype("float").isna()
#+end_src

#+RESULTS:
#+begin_example
key_plot_id                                        date      
CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater  2023-06-11    False
                                                   2023-06-12    False
                                                   2023-06-13    False
                                                   2023-06-14    False
                                                   2023-06-15    False
                                                                 ...  
WWS_ca_1703_Treatment plant_post grit removal      2023-11-09    False
                                                   2023-11-10    False
                                                   2023-11-11    False
                                                   2023-11-12    False
                                                   2023-11-13    False
Name: population_served, Length: 756993, dtype: bool
#+end_example

** sample location
#+begin_quote
Sample collection location in the wastewater system, whether at a wastewater treatment plant (or other community level treatment infrastructure such as community-scale septic) or upstream in the wastewater system.
#+end_quote
binary variable
#+begin_src jupyter-python :session *nwss
df_metric.sample_location.unique()
#+end_src

#+RESULTS:
: array(['Treatment plant', 'Before treatment plant'], dtype=object)

With before treatment saying that sample_location_specify has meaningful content
*** sample_location_specify
#+begin_quote
A unique identifier for "upstream" sample locations. Specifically, when 'sample_location' is "upstream", this field has a non-empty value, which provides a unique, but anonymous identifier for the upstream sample collection sites. This identifier is consistent over time, such that the same sample collection site retains the same ID regardless of the addition or subtraction of other sample collection sites from the data set.
#+end_quote

#+begin_src jupyter-python :session *nwss
df_metric.groupby(by = "sample_location").agg({"sample_location_specify": "nunique"})
#+end_src

#+RESULTS:
:                         sample_location_specify
: sample_location
: Before treatment plant                       86
: Treatment plant                              18

#+begin_src jupyter-python :session *nwss
before_treatment_values = df_metric.sample_location_specify[df_metric.sample_location == "Before treatment plant"].unique()
before_treatment_values = before_treatment_values.astype(float)
before_treatment_values
#+end_src

#+RESULTS:
: array([ 21., 147., 550., 468.,  95.,  86.,  96.,  94., 490., 113., 488.,
:        482.,  97., 222., 574., 466., 171., 305.,  17., 206.,  91., 301.,
:        553.,  98., 122., 481., 123., 223., 549., 145., 300., 500., 142.,
:         82., 524., 203., 208., 224., 546., 469., 116., 128., 221.,  16.,
:        126., 130., 124., 525.,  75., 491., 470., 229.,  20., 129., 227.,
:        465.,  19., 119., 483.,  78., 526.,  99.,  76.,  18.,  92., 156.,
:        489., 484.,  77., 357., 464., 141., 121., 452.,  79., 127., 499.,
:          7., 302.,  80., 205., 207.,  84.,  83.,  93., 125.])

#+begin_src jupyter-python :session *nwss
treatment_plant_values = df_metric.sample_location_specify[df_metric.sample_location == "Treatment plant"].unique()
treatment_plant_values = treatment_plant_values.astype(float)
treatment_plant_values
#+end_src

#+RESULTS:
: array([ nan, 459., 496.,   3., 497., 570., 552., 467., 495.,   7., 457.,
:        494., 514.,   2., 493., 515.,  85., 568., 569.])
Strangely, this is not just the singleton nan...

Do these overlap?
#+begin_src jupyter-python :session *nwss
np.intersect1d(treatment_plant_values, before_treatment_values)
#+end_src

#+RESULTS:
: array([7.])

Sooo there is one single intersection... how strange

** =county_names= & =county_fips=
#+begin_src jupyter-python :session *nwss
len(df_metric.county_fips.unique())
#+end_src

#+RESULTS:
: 844

#+begin_src jupyter-python :session *nwss
unique_fips = df_metric.county_fips.unique()
np.extract("," , unique_fips)
multi_fips = [x for x in unique_fips if ',' in x]
single_fips = [x for x in unique_fips if not ',' in x]
(len(multi_fips), len(single_fips))
#+end_src

#+RESULTS:
| 103 | 741 |
so there's an appreciable number with multi-counties per sample area

** =pcr_conc_smoothed=
#+begin_src jupyter-python :session *nwss
df[df["pcr_conc_smoothed"].isna()].sort_values("date")
#+end_src

#+RESULTS:
#+begin_example
                                              key_plot_id        date  \
19899   NWSS_az_1212_Before treatment plant_92_raw was...  2020-04-22
21827   NWSS_az_1212_Before treatment plant_93_raw was...  2020-04-22
372561  NWSS_az_1212_Before treatment plant_95_raw was...  2020-04-22
373861  NWSS_az_1212_Before treatment plant_96_raw was...  2020-04-22
375818  NWSS_az_1212_Before treatment plant_97_raw was...  2020-04-22
...                                                   ...         ...
347102      WWS_tx_1761_Treatment plant_post grit removal  2023-12-03
697967      WWS_fl_1841_Treatment plant_post grit removal  2023-12-03
352307      WWS_vt_2108_Treatment plant_post grit removal  2023-12-03
346925         WWS_tx_1683_Treatment plant_primary sludge  2023-12-03
710252      WWS_ut_1708_Treatment plant_post grit removal  2023-12-03

       pcr_conc_smoothed normalization
19899                NaN           NaN
21827                NaN           NaN
372561               NaN           NaN
373861               NaN           NaN
375818               NaN           NaN
...                  ...           ...
347102               NaN           NaN
697967               NaN           NaN
352307               NaN           NaN
346925               NaN           NaN
710252               NaN           NaN

[18528 rows x 4 columns]
#+end_example

** Map between =wwtp_id= and =county_fips=?
It would be good to know if one is a subset of the other. Somewhat difficult to actually calculate.

*** =wwtp_id= -> =county_fips=?
First, for each =wwtp_id=, how many =county_fips= are there, out of 1478 total?
#+begin_src jupyter-python :session *nwss
df_metric.groupby(by = ["wwtp_jurisdiction", "wwtp_id"]).agg({"county_fips" : "nunique"}).sort_values(by="county_fips").groupby(by = "county_fips").agg({"county_fips": "count"})
#+end_src

#+RESULTS:
:              county_fips
: county_fips
: 1                   1531
: 2                      6
: 3                      1
so there are several with 2, and one with 3 and only 12 treatment plants which are off. To see their populations and the counties they cover:
#+begin_src jupyter-python :session *nwss
pd.set_option("display.width", 100)
counties = df_metric.groupby(["wwtp_jurisdiction", "wwtp_id"]).agg({"county_fips" : "nunique",
                                             "population_served" : "mean", "wwtp_jurisdiction" : lambda x:
                                             x.unique().tolist(), "county_names" : lambda x:
                                             x.unique().tolist()}).sort_values(by="county_fips")
counties.population_served = counties.population_served.astype(int)
counties[counties.county_fips > 1].drop("county_fips", axis=1).sort_values(by = "population_served")
#+end_src

#+RESULTS:
#+begin_example
                           population_served wwtp_jurisdiction  \
wwtp_jurisdiction wwtp_id
North Carolina    569                  23896  [North Carolina]
Michigan          1729                 28284        [Michigan]
Florida           1735                 83953         [Florida]
Utah              11                   91995            [Utah]
California        363                 156426      [California]
Minnesota         1108                254089       [Minnesota]
New Jersey        788                1500000      [New Jersey]

                                                                county_names
wwtp_jurisdiction wwtp_id
North Carolina    569                                [Lenoir, Greene,Lenoir]
Michigan          1729                              [Wayne, Macomb, Oakland]
Florida           1735                           [Seminole, Orange,Seminole]
Utah              11                             [Utah,Salt Lake, Salt Lake]
California        363               [San Francisco,San Mateo, San Francisco]
Minnesota         1108                 [Scott,Dakota, Scott,Hennepin,Dakota]
New Jersey        788      [Essex,Hudson,Passaic,Bergen, Essex,Hudson,Uni...
#+end_example
                           population_served wwtp_jurisdiction                                       county_names
wwtp_jurisdiction wwtp_id
North Carolina    569                  23896  [North Carolina]                            [Lenoir, Greene,Lenoir]
Michigan          1729                 28284        [Michigan]                           [Wayne, Macomb, Oakland]
Florida           1735                 83953         [Florida]                        [Seminole, Orange,Seminole]
Utah              11                   91995            [Utah]                        [Utah,Salt Lake, Salt Lake]
California        363                 156426      [California]           [San Francisco,San Mateo, San Francisco]
Minnesota         1108                254089       [Minnesota]              [Scott,Dakota, Scott,Hennepin,Dakota]
New Jersey        788                1500000      [New Jersey]  [Essex,Hudson,Passaic,Bergen, Essex,Hudson,Uni...

And to see what the actual counties in NJ are
#+begin_src jupyter-python :session *nwss
counties[counties.county_fips > 1].sort_values(by = "population_served").iloc[-1,:].county_names
#+end_src

#+RESULTS:
| Essex,Hudson,Passaic,Bergen | Essex,Hudson,Union,Passaic,Bergen |

Looking at the example crossing 3 counties:
#+begin_src jupyter-python :session *nwss
df_metric[(df_metric.wwtp_id == 1729) & (df_metric.date_start=="2022-12-05")].transpose()
#+end_src

#+RESULTS:
#+begin_example
                                                                    136329  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_466_raw wa...
county_names                                                         Wayne
county_fips                                                          26163
population_served                                                    51939
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                      100.0
percentile                                                            93.0
sampling_prior                                                          no
first_sample_date                                               2022-12-19
ptc_15d                                                                NaN
sample_location_specify                                              466.0

                                                                    142240  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_305_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                     4934
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                      100.0
percentile                                                            87.5
sampling_prior                                                         yes
first_sample_date                                               2021-07-21
ptc_15d                                                              339.0
sample_location_specify                                              305.0

                                                                    150923  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_206_raw wa...
county_names                                                       Oakland
county_fips                                                          26125
population_served                                                     3080
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                        NaN
percentile                                                             NaN
sampling_prior                                                         yes
first_sample_date                                               2021-09-02
ptc_15d                                                                NaN
sample_location_specify                                              206.0

                                                                    167697  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_301_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                    29555
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                      100.0
percentile                                                            71.0
sampling_prior                                                         yes
first_sample_date                                               2021-07-21
ptc_15d                                                              -54.0
sample_location_specify                                              301.0

                                                                    271748  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_300_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                    19662
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                      100.0
percentile                                                            74.0
sampling_prior                                                         yes
first_sample_date                                               2021-07-21
ptc_15d                                                              -28.0
sample_location_specify                                              300.0

                                                                    312644  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_203_raw wa...
county_names                                                         Wayne
county_fips                                                          26163
population_served                                                     5190
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                        NaN
percentile                                                             NaN
sampling_prior                                                         yes
first_sample_date                                               2021-09-01
ptc_15d                                                                NaN
sample_location_specify                                              203.0

                                                                    313419  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_208_raw wa...
county_names                                                       Oakland
county_fips                                                          26125
population_served                                                     5800
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                        NaN
percentile                                                             NaN
sampling_prior                                                         yes
first_sample_date                                               2021-09-02
ptc_15d                                                                NaN
sample_location_specify                                              208.0

                                                                    582954  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_302_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                    56026
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                      100.0
percentile                                                          66.667
sampling_prior                                                         yes
first_sample_date                                               2021-07-21
ptc_15d                                                              -85.0
sample_location_specify                                              302.0

                                                                    594746  \
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_205_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                    99970
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                        NaN
percentile                                                             NaN
sampling_prior                                                         yes
first_sample_date                                               2021-08-31
ptc_15d                                                                NaN
sample_location_specify                                              205.0

                                                                    595523
wwtp_jurisdiction                                                 Michigan
wwtp_id                                                               1729
reporting_jurisdiction                                            Michigan
sample_location                                     Before treatment plant
key_plot_id              NWSS_mi_1729_Before treatment plant_207_raw wa...
county_names                                                        Macomb
county_fips                                                          26099
population_served                                                    37570
date_start                                                      2022-12-05
date_end                                                        2022-12-19
detect_prop_15d                                                        NaN
percentile                                                             NaN
sampling_prior                                                         yes
first_sample_date                                               2021-08-31
ptc_15d                                                                NaN
sample_location_specify                                              207.0
#+end_example

and to get a shorter view, looking at just the =key_plot_id='s, since those seem to capture all the key values (key as in database).
#+begin_src jupyter-python :session *nwss
df_metric[(df_metric.wwtp_id == '1729') & (df_metric.date_start=="2022-12-05")].key_plot_id.unique()
#+end_src

#+RESULTS:
#+begin_example
array(['NWSS_mi_1729_Before treatment plant_466_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_305_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_206_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_301_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_300_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_203_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_208_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_302_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_205_raw wastewater',
       'NWSS_mi_1729_Before treatment plant_207_raw wastewater'],
      dtype=object)
#+end_example

=wwtp_id==1729= is a before treatment plant sample, and has multiple =sample_location_specify= values, so they are sampling at several locations upstream of the treatment plant, some of which also happen to be in different counties.

Doe

*** =county_fips= -> =wwtp_id=?
First, for each =wwtp_id=, how many =county_fips= are there?
#+begin_src jupyter-python :session *nwss
df_metric.groupby(by = "county_fips").agg({"wwtp_id" : "nunique"}).sort_values(by="wwtp_id")
#+end_src

#+RESULTS:
#+begin_example
             wwtp_id
county_fips
01033              1
28071              1
29007              1
29009              1
29009,29109        1
...              ...
17043             10
15003             10
17031             12
48113             13
48201             30

[844 rows x 1 columns]
#+end_example
So there are more counties with several to many =wwtp_id='s. For example:
#+begin_src jupyter-python :session *nwss

df_metric[(df_metric.county_fips == '48201') & (df_metric.date_start=="2022-12-05")].transpose()
#+end_src

*** =key_plot_id= -> =county_fips=
Since =key_plot_id= is unique in a way that the treatment plant id alone isn't, lets see how that maps to counties. the awkward thing is the counties are listed in character strings, so we have to use the length of an entry.
#+begin_src jupyter-python :session *nwss
df_metric["county_length"] = df_metric.county_fips.apply(lambda x: (len(x)+1)/6)
df_metric.sort_values("county_length")
df_metric.county_fips = df_metric.county_fips.apply(lambda x: x.split(","))
df_metric.sort_values("county_length")
#+end_src

#+RESULTS:
#+begin_example
       wwtp_jurisdiction wwtp_id reporting_jurisdiction  sample_location  \
0               Arkansas    1548               Arkansas  Treatment plant
493138            Oregon     958                 Oregon  Treatment plant
493139            Oregon     958                 Oregon  Treatment plant
493140            Oregon     958                 Oregon  Treatment plant
493141            Oregon     958                 Oregon  Treatment plant
...                  ...     ...                    ...              ...
502250          Virginia    1838               Virginia  Treatment plant
502249          Virginia    1838               Virginia  Treatment plant
502248          Virginia    1838               Virginia  Treatment plant
502429          Virginia    1838               Virginia  Treatment plant
502317          Virginia    1838               Virginia  Treatment plant

                                              key_plot_id  \
0       CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
493138         NWSS_or_958_Treatment plant_raw wastewater
493139         NWSS_or_958_Treatment plant_raw wastewater
493140         NWSS_or_958_Treatment plant_raw wastewater
493141         NWSS_or_958_Treatment plant_raw wastewater
...                                                   ...
502250        NWSS_va_1838_Treatment plant_raw wastewater
502249        NWSS_va_1838_Treatment plant_raw wastewater
502248        NWSS_va_1838_Treatment plant_raw wastewater
502429        NWSS_va_1838_Treatment plant_raw wastewater
502317        NWSS_va_1838_Treatment plant_raw wastewater

                                             county_names  \
0                                               Jefferson
493138                                            Malheur
493139                                            Malheur
493140                                            Malheur
493141                                            Malheur
...                                                   ...
502250  Prince William,Fairfax,Fauquier,Loudoun,Fairfa...
502249  Prince William,Fairfax,Fauquier,Loudoun,Fairfa...
502248  Prince William,Fairfax,Fauquier,Loudoun,Fairfa...
502429  Prince William,Fairfax,Fauquier,Loudoun,Fairfa...
502317  Prince William,Fairfax,Fauquier,Loudoun,Fairfa...

                                              county_fips population_served  \
0                                                 [05069]             42323
493138                                            [41045]             10966
493139                                            [41045]             10966
493140                                            [41045]             10966
493141                                            [41045]             10966
...                                                   ...               ...
502250  [51061, 51600, 51685, 51683, 51107, 51153, 51059]            350000
502249  [51061, 51600, 51685, 51683, 51107, 51153, 51059]            350000
502248  [51061, 51600, 51685, 51683, 51107, 51153, 51059]            350000
502429  [51061, 51600, 51685, 51683, 51107, 51153, 51059]            350000
502317  [51061, 51600, 51685, 51683, 51107, 51153, 51059]            350000

        date_start    date_end detect_prop_15d percentile sampling_prior  \
0       2023-06-11  2023-06-25             100       10.0             no
493138  2022-01-29  2022-02-12             100       88.0            yes
493139  2022-01-30  2022-02-13             100       88.0            yes
493140  2022-01-31  2022-02-14             100       78.0            yes
493141  2022-02-01  2022-02-15             100       65.5            yes
...            ...         ...             ...        ...            ...
502250  2023-05-04  2023-05-18             100     93.667             no
502249  2023-05-03  2023-05-17             100     93.667             no
502248  2023-05-02  2023-05-16             100     93.667             no
502429  2023-10-30  2023-11-13              33     22.667             no
502317  2023-07-10  2023-07-24               0     34.333             no

       first_sample_date ptc_15d sample_location_specify  \
0             2023-06-25     NaN                     NaN
493138        2020-09-15     -76                     NaN
493139        2020-09-15     -76                     NaN
493140        2020-09-15     -77                     NaN
493141        2020-09-15     -82                     NaN
...                  ...     ...                     ...
502250        2023-04-10      43                     NaN
502249        2023-04-10      43                     NaN
502248        2023-04-10      43                     NaN
502429        2023-04-10     -66                     NaN
502317        2023-04-10       0                     NaN

                            issue  county_length
0      2023-11-24 13:29:15.297265            1.0
493138 2023-11-24 13:29:15.297265            1.0
493139 2023-11-24 13:29:15.297265            1.0
493140 2023-11-24 13:29:15.297265            1.0
493141 2023-11-24 13:29:15.297265            1.0
...                           ...            ...
502250 2023-11-24 13:29:15.297265            7.0
502249 2023-11-24 13:29:15.297265            7.0
502248 2023-11-24 13:29:15.297265            7.0
502429 2023-11-24 13:29:15.297265            7.0
502317 2023-11-24 13:29:15.297265            7.0

[743903 rows x 18 columns]
#+end_example

*** =wwtp_id= -> =sample_location_specify=
Are there treatment plants with samples upstream as well?
#+begin_src jupyter-python :session *nwss
df_metric.transpose()
#+end_src

#+RESULTS:
#+begin_example
                                                                    0       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-11
date_end                                                        2023-06-25
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    1       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-12
date_end                                                        2023-06-26
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    2       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-13
date_end                                                        2023-06-27
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    3       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-14
date_end                                                        2023-06-28
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    4       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-15
date_end                                                        2023-06-29
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    5       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-16
date_end                                                        2023-06-30
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    6       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-17
date_end                                                        2023-07-01
detect_prop_15d                                                      100.0
percentile                                                            10.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    7       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-18
date_end                                                        2023-07-02
detect_prop_15d                                                      100.0
percentile                                                             5.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                              -25.0
sample_location_specify                                                NaN

                                                                    8       \
wwtp_jurisdiction                                                 Arkansas
wwtp_id                                                               1548
reporting_jurisdiction                                            Arkansas
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater
county_names                                                     Jefferson
county_fips                                                          05069
population_served                                                    42323
date_start                                                      2023-06-19
date_end                                                        2023-07-03
detect_prop_15d                                                      100.0
percentile                                                             5.0
sampling_prior                                                          no
first_sample_date                                               2023-06-25
ptc_15d                                                              -25.0
sample_location_specify                                                NaN

                                                                    9       ...  \
wwtp_jurisdiction                                                 Arkansas  ...
wwtp_id                                                               1548  ...
reporting_jurisdiction                                            Arkansas  ...
sample_location                                            Treatment plant  ...
key_plot_id              CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater  ...
county_names                                                     Jefferson  ...
county_fips                                                          05069  ...
population_served                                                    42323  ...
date_start                                                      2023-06-20  ...
date_end                                                        2023-07-04  ...
detect_prop_15d                                                      100.0  ...
percentile                                                             5.0  ...
sampling_prior                                                          no  ...
first_sample_date                                               2023-06-25  ...
ptc_15d                                                              -15.0  ...
sample_location_specify                                                NaN  ...

                                                                701162  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-23
date_end                                                    2023-10-07
detect_prop_15d                                                  100.0
percentile                                                      44.286
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                          -21.0
sample_location_specify                                            NaN

                                                                701163  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-24
date_end                                                    2023-10-08
detect_prop_15d                                                  100.0
percentile                                                      44.286
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                          -21.0
sample_location_specify                                            NaN

                                                                701164  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-25
date_end                                                    2023-10-09
detect_prop_15d                                                  100.0
percentile                                                      44.286
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                          -21.0
sample_location_specify                                            NaN

                                                                701165  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-26
date_end                                                    2023-10-10
detect_prop_15d                                                  100.0
percentile                                                      44.286
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                          -19.0
sample_location_specify                                            NaN

                                                                701166  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-27
date_end                                                    2023-10-11
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                            5.0
sample_location_specify                                            NaN

                                                                701167  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-28
date_end                                                    2023-10-12
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                           13.0
sample_location_specify                                            NaN

                                                                701168  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-29
date_end                                                    2023-10-13
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                           13.0
sample_location_specify                                            NaN

                                                                701169  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-09-30
date_end                                                    2023-10-14
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                           43.0
sample_location_specify                                            NaN

                                                                701170  \
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-10-01
date_end                                                    2023-10-15
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                           43.0
sample_location_specify                                            NaN

                                                                701171
wwtp_jurisdiction                                             Maryland
wwtp_id                                                           1808
reporting_jurisdiction                                        Maryland
sample_location                                        Treatment plant
key_plot_id              WWS_md_1808_Treatment plant_post grit removal
county_names                                               Saint Marys
county_fips                                                      24037
population_served                                                55000
date_start                                                  2023-10-02
date_end                                                    2023-10-16
detect_prop_15d                                                  100.0
percentile                                                      40.167
sampling_prior                                                      no
first_sample_date                                           2023-01-04
ptc_15d                                                           43.0
sample_location_specify                                            NaN

[16 rows x 701172 columns]
#+end_example

*** Are populations per-county?
#+begin_src jupyter-python :session *nwss
pop_wwtp = df_metric.groupby("county_fips").agg({"population_served": "nunique", "key_plot_id" : "nunique"})
pop_wwtp[pop_wwtp.key_plot_id > 1].sort_values(by = "population_served")
#+end_src

#+RESULTS:
#+begin_example
             population_served  key_plot_id
county_fips
26075                        1            2
20057                        1            2
18177                        1            2
18167                        1            2
18157                        1            2
...                        ...          ...
26139                       13           13
04013                       20           13
17031                       21           21
49043                       22            2
48201                       29           30

[342 rows x 2 columns]
#+end_example

*** Population
#+begin_src jupyter-python :session *nwss
df_metric.groupby("key_plot_id").agg({"population_served" : "mean"}).sum().astype(int)
#+end_src

#+RESULTS:
: population_served    207990158
: dtype: int64

** Dates

#+begin_src jupyter-python :session *nwss
t = (pd.to_datetime(df_metric["date_start"]) - pd.to_datetime(df_metric["date_end"])).unique()
np.timedelta64(t[0], "D")
#+end_src

#+RESULTS:
: numpy.timedelta64(-14,'D')

all are from exactly 2 week averages, but the frequencies are somewhat difficult to compute.

#+begin_src jupyter-python :session *nwss
df_metric.groupby(by="wwtp_id").agg({"date_start" : "nunique"})
#np.diff(pd.to_datetime(df_metric["date_start"])))
#+end_src

#+RESULTS:
#+begin_example
         date_start
wwtp_id
1               801
10              801
1000            541
1006            135
1007            618
...             ...
995             534
996             541
997             633
998             541
999             136

[1478 rows x 1 columns]
#+end_example

* Concentration Data
#+begin_src jupyter-python :session *nwss
import os
import numpy as np
import pandas as pd
from sodapy import Socrata
concentration = pd.read_csv("concentration.csv")
concentration
#+end_src

#+RESULTS:
#+begin_example
         Unnamed: 0                                        key_plot_id  \
0                 0  CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
1                 1  CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
2                 2  CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
3                 3  CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
4                 4  CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
...             ...                                                ...
2318444     2318444      WWS_tn_2345_Treatment plant_post grit removal
2318445     2318445      WWS_tx_1949_Treatment plant_post grit removal
2318446     2318446      WWS_tx_1949_Treatment plant_post grit removal
2318447     2318447      WWS_ut_1708_Treatment plant_post grit removal
2318448     2318448      WWS_ut_1708_Treatment plant_post grit removal

               date  pcr_conc_smoothed    normalization  \
0        2023-06-20        343671600.0  flow-population
1        2023-06-21        352803900.0  flow-population
2        2023-06-26        422806200.0  flow-population
3        2023-06-27        446172400.0  flow-population
4        2023-06-28        472180700.0  flow-population
...             ...                ...              ...
2318444  2023-11-02                NaN        microbial
2318445  2023-11-02                NaN        microbial
2318446  2023-11-05                NaN              NaN
2318447  2023-11-02                NaN        microbial
2318448  2023-11-05                NaN              NaN

                              issue
0        2023-11-06 02:08:23.110558
1        2023-11-06 02:08:23.110558
2        2023-11-06 02:08:23.110558
3        2023-11-06 02:08:23.110558
4        2023-11-06 02:08:23.110558
...                             ...
2318444  2023-11-06 02:08:23.110558
2318445  2023-11-06 02:08:23.110558
2318446  2023-11-06 02:08:23.110558
2318447  2023-11-06 02:08:23.110558
2318448  2023-11-06 02:08:23.110558

[2318449 rows x 6 columns]
#+end_example

#+begin_src jupyter-python :session *nwss
concentration.columns
#+end_src

#+RESULTS:
: Index(['Unnamed: 0', 'key_plot_id', 'date', 'pcr_conc_smoothed',
:        'normalization', 'issue'],
:       dtype='object')

#+begin_src jupyter-python :session *nwss
concentration.normalization.unique()
#+end_src

#+RESULTS:
: array(['flow-population', nan, 'microbial'], dtype=object)

#+begin_src jupyter-python :session *nwss
concentration.key_plot_id.unique()
#+end_src

#+RESULTS:
: array(['CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater',
:        'CDC_BIOBOT_ak_1172_Treatment plant_raw wastewater',
:        'CDC_BIOBOT_al_1394_Treatment plant_raw wastewater', ...,
:        'NWSS_az_2459_Before treatment plant_97_raw wastewater',
:        'NWSS_az_2459_Before treatment plant_98_raw wastewater',
:        'NWSS_az_2459_Before treatment plant_99_raw wastewater'],
:       dtype=object)

* General questions
** For the concentration data, is the normalization duplicated at locations?
#+begin_src jupyter-python :session *nwss
np.mean(concentration.groupby("key_plot_id").agg({"normalization": "nunique"}).normalization)
#+end_src

#+RESULTS:
: 1.0129358830146231
ok, so there's about 1% which have both forms of normalization
#+begin_src jupyter-python :session *nwss
np.mean(concentration.groupby("key_plot_id").agg({"normalization": "nunique"}).normalization)
#+end_src
** Does the concentration data and the normalized data have exactly the same keys?
#+begin_src jupyter-python :session *nwss
df_metric.transpose()
#df_metric.astype(str) + "_" + df_metric.wwtp_id.astype(str)
concentration.key_plot_id
df_metric.key_plot_id.unique == concentration.key_plot_id.unique
#+end_src

#+RESULTS:
:RESULTS:
# [goto error]
: [0;31m---------------------------------------------------------------------------[0m
: [0;31mNameError[0m                                 Traceback (most recent call last)
: Cell [0;32mIn[4], line 1[0m
: [0;32m----> 1[0m df_metric[38;5;241m.[39mtranspose()
: [1;32m      2[0m [38;5;66;03m#df_metric.astype(str) + "_" + df_metric.wwtp_id.astype(str)[39;00m
: [1;32m      3[0m concentration[38;5;241m.[39mkey_plot_id
:
: [0;31mNameError[0m: name 'df_metric' is not defined
:END:

#+begin_src jupyter-python :session *nwss
df_metric.transpose()
#+end_src

#+RESULTS:
#+begin_example
                                                                    0       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-06
date_end                                                        2023-06-20
detect_prop_15d                                                      100.0
percentile                                                            23.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    1       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-07
date_end                                                        2023-06-21
detect_prop_15d                                                      100.0
percentile                                                            23.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    2       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-08
date_end                                                        2023-06-22
detect_prop_15d                                                      100.0
percentile                                                            23.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    3       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-09
date_end                                                        2023-06-23
detect_prop_15d                                                      100.0
percentile                                                            23.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    4       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-10
date_end                                                        2023-06-24
detect_prop_15d                                                      100.0
percentile                                                            23.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                NaN
sample_location_specify                                                NaN

                                                                    5       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-11
date_end                                                        2023-06-25
detect_prop_15d                                                      100.0
percentile                                                            25.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                               85.0
sample_location_specify                                                NaN

                                                                    6       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-12
date_end                                                        2023-06-26
detect_prop_15d                                                      100.0
percentile                                                            25.0
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                               85.0
sample_location_specify                                                NaN

                                                                    7       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-13
date_end                                                        2023-06-27
detect_prop_15d                                                      100.0
percentile                                                          22.667
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                4.0
sample_location_specify                                                NaN

                                                                    8       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-14
date_end                                                        2023-06-28
detect_prop_15d                                                      100.0
percentile                                                          22.667
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                4.0
sample_location_specify                                                NaN

                                                                    9       \
wwtp_jurisdiction                                            New York City
wwtp_id                                                                545
reporting_jurisdiction                                       New York City
sample_location                                            Treatment plant
key_plot_id              CDC_BIOBOT_ny_545_Treatment plant_post grit re...
county_names                                                        Queens
county_fips                                                          36081
population_served                                                   728123
date_start                                                      2023-06-15
date_end                                                        2023-06-29
detect_prop_15d                                                      100.0
percentile                                                          22.667
sampling_prior                                                          no
first_sample_date                                               2023-06-20
ptc_15d                                                                4.0
sample_location_specify                                                NaN

                         ...                                       718854  \
wwtp_jurisdiction        ...                                West Virginia
wwtp_id                  ...                                         1864
reporting_jurisdiction   ...                                West Virginia
sample_location          ...                              Treatment plant
key_plot_id              ...  NWSS_wv_1864_Treatment plant_raw wastewater
county_names             ...                                       Cabell
county_fips              ...                                        54011
population_served        ...                                         7200
date_start               ...                                   2023-10-10
date_end                 ...                                   2023-10-24
detect_prop_15d          ...                                         67.0
percentile               ...                                       33.714
sampling_prior           ...                                           no
first_sample_date        ...                                   2022-10-18
ptc_15d                  ...                                        -31.0
sample_location_specify  ...                                          NaN

                                                              718855  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-11
date_end                                                  2023-10-25
detect_prop_15d                                                 60.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -57.0
sample_location_specify                                          NaN

                                                              718856  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-12
date_end                                                  2023-10-26
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -95.0
sample_location_specify                                          NaN

                                                              718857  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-13
date_end                                                  2023-10-27
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -95.0
sample_location_specify                                          NaN

                                                              718858  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-14
date_end                                                  2023-10-28
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -95.0
sample_location_specify                                          NaN

                                                              718859  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-15
date_end                                                  2023-10-29
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -95.0
sample_location_specify                                          NaN

                                                              718860  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-16
date_end                                                  2023-10-30
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                        -95.0
sample_location_specify                                          NaN

                                                              718861  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-17
date_end                                                  2023-10-31
detect_prop_15d                                                 67.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                       -100.0
sample_location_specify                                          NaN

                                                              718862  \
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-18
date_end                                                  2023-11-01
detect_prop_15d                                                 50.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                       -100.0
sample_location_specify                                          NaN

                                                              718863
wwtp_jurisdiction                                      West Virginia
wwtp_id                                                         1864
reporting_jurisdiction                                 West Virginia
sample_location                                      Treatment plant
key_plot_id              NWSS_wv_1864_Treatment plant_raw wastewater
county_names                                                  Cabell
county_fips                                                    54011
population_served                                               7200
date_start                                                2023-10-19
date_end                                                  2023-11-02
detect_prop_15d                                                  0.0
percentile                                                    33.714
sampling_prior                                                    no
first_sample_date                                         2022-10-18
ptc_15d                                                          NaN
sample_location_specify                                          NaN

[16 rows x 718864 columns]
#+end_example
** Missingness
What is the pattern of missing data
** Population changes in the record
It appears that the population values in the "population_served" column aren't stable. For example, take Yuma county in Arizona:
#+begin_src jupyter-python :session *nwss
df_metric[df_metric.key_plot_id == "NWSS_az_1055_Treatment plant_raw wastewater"].sort_values(["population_served", "date_start"], ascending = [True, False])
#+end_src
#+RESULTS:
#+begin_example
       wwtp_jurisdiction wwtp_id reporting_jurisdiction  sample_location  \
242215           Arizona    1055                Arizona  Treatment plant
242214           Arizona    1055                Arizona  Treatment plant
242213           Arizona    1055                Arizona  Treatment plant
242212           Arizona    1055                Arizona  Treatment plant
242211           Arizona    1055                Arizona  Treatment plant
...                  ...     ...                    ...              ...
242129           Arizona    1055                Arizona  Treatment plant
242128           Arizona    1055                Arizona  Treatment plant
242127           Arizona    1055                Arizona  Treatment plant
242126           Arizona    1055                Arizona  Treatment plant
242125           Arizona    1055                Arizona  Treatment plant

                                        key_plot_id county_names county_fips  \
242215  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242214  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242213  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242212  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242211  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
...                                             ...          ...         ...
242129  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242128  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242127  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242126  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027
242125  NWSS_az_1055_Treatment plant_raw wastewater         Yuma       04027

       population_served  date_start    date_end detect_prop_15d percentile  \
242215             20634  2023-11-05  2023-11-19              33       10.0
242214             20634  2023-11-04  2023-11-18              33       10.0
242213             20634  2023-11-03  2023-11-17              33       10.0
242212             20634  2023-11-02  2023-11-16              33       10.0
242211             20634  2023-11-01  2023-11-15               0        3.0
...                  ...         ...         ...             ...        ...
242129              8271  2023-08-11  2023-08-25             100       61.5
242128              8271  2023-08-10  2023-08-24             100       61.5
242127              8271  2023-08-09  2023-08-23             100       47.0
242126              8271  2023-08-08  2023-08-22             100       47.0
242125              8271  2023-08-07  2023-08-21             100       47.0

       sampling_prior first_sample_date ptc_15d sample_location_specify  \
242215             no        2023-08-21     503                     NaN
242214             no        2023-08-21     503                     NaN
242213             no        2023-08-21     503                     NaN
242212             no        2023-08-21     503                     NaN
242211             no        2023-08-21      -4                     NaN
...               ...               ...     ...                     ...
242129             no        2023-08-21   47816                     NaN
242128             no        2023-08-21   47816                     NaN
242127             no        2023-08-21     NaN                     NaN
242126             no        2023-08-21     NaN                     NaN
242125             no        2023-08-21     NaN                     NaN

                            issue
242215 2023-11-24 12:44:35.156271
242214 2023-11-24 12:44:35.156271
242213 2023-11-24 12:44:35.156271
242212 2023-11-24 12:44:35.156271
242211 2023-11-24 12:44:35.156271
...                           ...
242129 2023-11-24 12:44:35.156271
242128 2023-11-24 12:44:35.156271
242127 2023-11-24 12:44:35.156271
242126 2023-11-24 12:44:35.156271
242125 2023-11-24 12:44:35.156271

[91 rows x 17 columns]
#+end_example

This goes from 8271 to 20,634 in a single day. Neither matches the [[https://en.wikipedia.org/wiki/Yuma_County,_Arizona][wikipedia value]] of 203,881 (both off by an order of magnitude). Also doesn't match [[https://en.wikipedia.org/wiki/Yuma,_Arizona][the city of Yuma]]. Is this the only site in Yuma county?
#+begin_src jupyter-python :session *nwss
df_metric[(df_metric.county_names == "Yuma") & (df_metric.date_start == "2023-11-05")]
#+end_src

#+RESULTS:
#+begin_example
       wwtp_jurisdiction wwtp_id reporting_jurisdiction  \
163382           Arizona    1061                Arizona
165808           Arizona    1059                Arizona
242215           Arizona    1055                Arizona
309054           Arizona    1053                Arizona
650264           Arizona    1055                Arizona
682079           Arizona    1055                Arizona
707012           Arizona    1054                Arizona

               sample_location  \
163382         Treatment plant
165808         Treatment plant
242215         Treatment plant
309054  Before treatment plant
650264  Before treatment plant
682079  Before treatment plant
707012         Treatment plant

                                              key_plot_id county_names  \
163382        NWSS_az_1061_Treatment plant_raw wastewater         Yuma
165808        NWSS_az_1059_Treatment plant_raw wastewater         Yuma
242215        NWSS_az_1055_Treatment plant_raw wastewater         Yuma
309054  NWSS_az_1053_Before treatment plant_82_raw was...         Yuma
650264  NWSS_az_1055_Before treatment plant_84_raw was...         Yuma
682079  NWSS_az_1055_Before treatment plant_83_raw was...         Yuma
707012        NWSS_az_1054_Treatment plant_raw wastewater         Yuma

       county_fips population_served  date_start    date_end detect_prop_15d  \
163382       04027             25369  2023-11-05  2023-11-19             100
165808       04027             18039  2023-11-05  2023-11-19             100
242215       04027             20634  2023-11-05  2023-11-19              33
309054       04027              8271  2023-11-05  2023-11-19              75
650264       04027              4725  2023-11-05  2023-11-19             NaN
682079       04027             19000  2023-11-05  2023-11-19             NaN
707012       04027             10873  2023-11-05  2023-11-19             100

       percentile sampling_prior first_sample_date ptc_15d  \
163382       41.0            yes        2021-02-04     -99
165808     45.333            yes        2021-02-04     112
242215       10.0             no        2023-08-21     503
309054       36.0            yes        2021-02-04     149
650264        NaN            yes        2021-02-04     NaN
682079        NaN            yes        2021-02-04     NaN
707012       61.4            yes        2021-02-04     -76

       sample_location_specify                      issue
163382                     NaN 2023-11-24 12:44:35.156271
165808                     NaN 2023-11-24 12:44:35.156271
242215                     NaN 2023-11-24 12:44:35.156271
309054                      82 2023-11-24 12:44:35.156271
650264                      84 2023-11-24 12:44:35.156271
682079                      83 2023-11-24 12:44:35.156271
707012                     NaN 2023-11-24 12:44:35.156271
#+end_example
So there are actually 7 sample sites in the county. Anyways, this implies that in the case of population weighting, we either
1. Are off by potentially an order of magnitude if we take a fixed population for each site
2. Need to use a date dependent version of the aggregator, and so storing it separately in e.g. the geomapper is probably not a good idea. At least for the case
Confirmed that this is the only thing that makes the key_id field non-unique, so the other fields can be stored.
** treatment plant counties stable over time
** Is the normalization stable over time
** Is the normalization unique per site?
#+begin_src jupyter-python :session *nwss
df_metric.set_index(["date_start", "key_plot_id"]).index.duplicated().sum()
#df_metric.columns
#+end_src

#+RESULTS:
: 0

Yes! for metric
#+begin_src jupyter-python :session *nwss
df.set_index(["date", "key_plot_id"]).index.duplicated().sum()
#df_metric.columns

Normalization isn't listed in the key, so it is uniquely tied to key, and thus sampling procedure
** Is the sampling procedure unique per-site?
#+begin_src jupyter-python :session *nwss
df_metric.columns
#+end_src

#+RESULTS:
: Index(['wwtp_jurisdiction', 'wwtp_id', 'reporting_jurisdiction',
:        'sample_location', 'county_names', 'county_fips', 'population_served',
:        'date_end', 'detect_prop_15d', 'percentile', 'sampling_prior',
:        'first_sample_date', 'ptc_15d', 'sample_location_specify'],
:       dtype='object')

#+begin_src jupyter-python :session *nwss
metric = df_metric.reset_index()
metric.sample_location_specify = metric.sample_location_specify.astype("float", copy=False)
sum_max = metric.groupby(["date_end", "wwtp_jurisdiction", "wwtp_id"]).agg({"sample_location_specify" : ["sum", "max"]})
[(sum_max["sample_location_specify", "sum"] == 0).sum(), (sum_max["sample_location_specify", "max"].isna()).sum()]
#metric.sample_location_specify.sort_values()
#metric.transpose()
#+end_src

#+RESULTS:
| 671951 | 671951 |

sum ignores NA's, while max returns an NaN if any are (thus the different checks). So the number that are all NaN is equal to the number that contain any NaNs.

#+begin_src jupyter-python :session *nwss
metric.sample_location_specify.sort_values()
#+end_src

#+RESULTS:
#+begin_example
548281    2.0
548309    2.0
548310    2.0
548311    2.0
548312    2.0
         ...
756988    NaN
756989    NaN
756990    NaN
756991    NaN
756992    NaN
Name: sample_location_specify, Length: 756993, dtype: float64
#+end_example

* Signals and general thoughts
So we should probably provide at least 3 different signals- the joined data, the Biobot data, the verily data, possibly a 4th that is the public health supplied data.


CAN WE ADD PROVIDER AS A COLUMN?

how to handle the addition of 2-3 geos (1 of which is novel), and 2 signals.

One annoying thing is that the concentration data has all of it's columns jammed together. It may be easier to join the two by first making a synthetic =key_id= for the metric data, joining on it, and then +dropping it+ using it as the basis for our key.
** Dealing with =geo_type=
#+begin_quote
it might have more detailed information about the plants such that we could try to do some GIS tricks to intersect the catchment polygons with the county polygons. We would then have to decide whether or how to apportion the WW numbers to the corresponding portions of counties.
#+end_quote
So for county level aggregation specifically, I'm not sure why we would need to get this complicated.
* Revision behavior
#+begin_src jupyter-python :session *nwss
concentration = pd.read_csv("concentration.csv", index_col=0, parse_dates=[-1])
concentration.iloc[0, :].transpose()
#+end_src

#+RESULTS:
: key_plot_id          CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
: date                                                        2023-06-20
: pcr_conc_smoothed                                          343671600.0
: normalization                                          flow-population
: issue                                       2023-11-15 02:08:07.964267
: Name: 0, dtype: object

To figure out the revision behavior, its best to group by (key_plot_id, date, and normalization)
#+begin_src jupyter-python :session *nwss
issue_counts = concentration.groupby(["key_plot_id", "date", "normalization"]).agg({"issue" : "count"})
issue_counts.sort_values(by=["issue", "date"])
concentration
#+end_src

#+RESULTS:
#+begin_example
                                               key_plot_id        date  pcr_conc_smoothed    normalization                      issue
0        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  2023-06-20       3.436716e+08  flow-population 2023-11-15 02:08:07.964267
1        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  2023-06-21       3.528039e+08  flow-population 2023-11-15 02:08:07.964267
2        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  2023-06-26       4.228062e+08  flow-population 2023-11-15 02:08:07.964267
3        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  2023-06-27       4.461724e+08  flow-population 2023-11-15 02:08:07.964267
4        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  2023-06-28       4.721807e+08  flow-population 2023-11-15 02:08:07.964267
...                                                    ...         ...                ...              ...                        ...
2943035      WWS_ut_1708_Treatment plant_post grit removal  2022-12-04       7.000000e-04        microbial 2023-11-15 02:08:07.964267
2943036      WWS_ut_1708_Treatment plant_post grit removal  2023-11-06       5.000000e-04        microbial 2023-11-15 02:08:07.964267
2943037      WWS_ut_1708_Treatment plant_post grit removal  2023-11-07       5.000000e-04        microbial 2023-11-15 02:08:07.964267
2943038      WWS_ut_1708_Treatment plant_post grit removal  2023-11-08       5.000000e-04        microbial 2023-11-15 02:08:07.964267
2943039      WWS_ut_1708_Treatment plant_post grit removal  2023-11-14                NaN              NaN 2023-11-15 02:08:07.964267

[2_943_040 rows x 5 columns]
#+end_example

Kind of odd that 2022-06-06 is getting revision; looking at that specifically:
#+begin_src jupyter-python :session *nwss
pd.set_option("display.max_columns", None)
pd.set_option("display.expand_frame_repr", False)
concentration.loc[(concentration.date == "2022-06-27") & (concentration.key_plot_id == "NWSS_wi_231_Treatment plant_raw wastewater")]
#issue_counts.loc[date == "2022-06-27"]
#+end_src

#+RESULTS:
#+begin_example
                                        key_plot_id        date  pcr_conc_smoothed    normalization                      issue
253544   NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186360700.0  flow-population 2023-10-17 14:52:28.829755
709853   NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186227500.0  flow-population 2023-10-18 17:03:56.272893
899174   NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186227400.0  flow-population 2023-10-20 14:08:36.830290
1080860  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186384700.0  flow-population 2023-10-23 11:08:09.292074
1183394  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186411400.0  flow-population 2023-10-24 02:08:09.872367
1324400  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186537900.0  flow-population 2023-10-27 02:08:11.826278
1614668  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186537800.0  flow-population 2023-10-30 02:08:10.331810
1793186  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186614100.0  flow-population 2023-10-31 02:08:08.438599
1978867  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186638000.0  flow-population 2023-11-03 02:08:22.196753
2256546  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186602400.0  flow-population 2023-11-07 02:08:07.873418
2476248  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186667000.0  flow-population 2023-11-10 02:08:07.124690
2708328  NWSS_wi_231_Treatment plant_raw wastewater  2022-06-27        186827600.0  flow-population 2023-11-15 02:08:07.964267
#+end_example
So apparently we're revising nearly /checks notes/ daily.

what fraction have some sort of revision?
#+begin_src jupyter-python :session *nwss
issue_counts = concentration.groupby(["key_plot_id", "date", "normalization"]).agg({"issue" : "count"})
iMultiIssues = issue_counts.issue > 1#].index
sum(issue_counts.issue > 1)/len(issue_counts)
#concentration.groupby(["key_plot_id", "date", "normalization"])
#+end_src

#+RESULTS:
: 0.7617054297756913
Roughly 75 percent have a revision of some sort. Let see how much they actually differ by:
#+begin_src jupyter-python :session *nwss
standard_errors = concentration.groupby(["key_plot_id", "date", "normalization"]).sem().sort_values(by="pcr_conc_smoothed")
standard_errors
#+end_src

#+RESULTS:
#+begin_example
                                                                                pcr_conc_smoothed                      issue
key_plot_id                                           date       normalization
NWSS_mi_890_Before treatment plant_145_raw wastewater 2022-06-16 microbial                0.00005  4 days 00:00:00.045424576
NWSS_il_635_Before treatment plant_16_raw wastewater  2022-07-29 microbial                0.00005  4 days 11:59:52.426854464
NWSS_il_674_Before treatment plant_20_raw wastewater  2023-02-18 microbial                0.00005  0 days 23:59:51.423344576
                                                      2023-04-09 microbial                0.00005 14 days 05:37:49.567256064
NWSS_ca_363_Before treatment plant_79_raw wastewater  2022-07-14 microbial                0.00005 14 days 05:37:49.567256064
...                                                                                           ...                        ...
WWS_wv_2207_Treatment plant_primary sludge            2023-11-07 microbial                    NaN  0 days 23:59:51.423344576
                                                      2023-11-08 microbial                    NaN  0 days 23:59:51.423344576
                                                      2023-11-09 microbial                    NaN                        NaT
                                                      2023-11-10 microbial                    NaN                        NaT
                                                      2023-11-11 microbial                    NaN                        NaT

[725518 rows x 2 columns]
#+end_example
So not that much
More tricky to figure out is how frequently they update

#+begin_src jupyter-python :session *nwss
concentration.groupby(["issue"]).agg({"issue" : "count"})#.rename(drop=True).sort_values(by="issue")
#+end_src

#+RESULTS:
#+begin_example
                             issue
issue
2023-10-17 14:52:28.829755  137954
2023-10-18 17:03:56.272893  179397
2023-10-19 10:19:22.155483   40964
2023-10-20 14:08:36.830290  102604
2023-10-23 11:08:09.292074  123735
2023-10-24 02:08:09.872367  140349
2023-10-25 02:08:22.482510  114039
2023-10-26 02:08:07.815905   70355
2023-10-27 02:08:11.826278   60444
2023-10-28 02:08:06.819847   37385
2023-10-30 02:08:10.331810  259946
2023-10-31 02:08:08.438599   81577
2023-11-01 02:08:12.444131  161566
2023-11-02 02:08:07.334087   20667
2023-11-03 02:08:22.196753   97767
2023-11-04 02:08:07.567107    4976
2023-11-05 02:08:06.514729     300
2023-11-06 02:08:23.110558   66776
2023-11-07 02:08:07.873418  174621
2023-11-08 02:08:13.225730   75656
2023-11-09 02:08:25.310360   62844
2023-11-10 02:08:07.124690   48963
2023-11-11 02:08:08.236941    1400
2023-11-12 02:08:06.443106     313
2023-11-13 02:08:25.117578   36301
2023-11-14 02:08:19.489678  169765
2023-11-15 02:08:07.964267  672376
#+end_example

** Things to figure out
how far back revisions normally go, if they only impact certain regions, how much values normally change, etc
* Copying =nchs_mortality=
- [x] [[file:~/allHail/delphi/covidcast-indicators/nchs_mortality/setup.py]]
- [ ] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/params.json.template
- [x] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/__init__.py
- [X] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/__main__.py
- [ ] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/pull.py
- [ ] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/run.py
- [ ] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/constants.py
  + present, but not actually having values, this will probably take some careful work. The use in different signals is somewhat inconsistent.
- [ ] file:~/allHail/delphi/covidcast-indicators/nchs_mortality/delphi_nchs_mortality/archive_diffs.py
  + calculate the difference over time, I guess I hacked the same idea
* Adding a geo-value
Several places, most principally the geomapper
* Release rate
* Dev notes
#+begin_src jupyter-python :session *nwss
df = pd.DataFrame.from_records(results)
df_metric = pd.DataFrame.from_records(results_metric)
df.columns
#+end_src

#+RESULTS:
: Index(['key_plot_id', 'date', 'pcr_conc_smoothed', 'normalization'], dtype='object')
#+begin_src jupyter-python :session *nwss
df.rename(columns={"date": "timestamp"}, inplace=True)
df.columns
#+end_src

#+RESULTS:
: Index(['key_plot_id', 'timestamp', 'pcr_conc_smoothed', 'normalization'], dtype='object')


#+begin_src jupyter-python :session *nwss
def sig_digit_round(value, N):
    """round the number of significant digits (x.xxe5 would be 3) to `N`."""
    in_value = value
    value = np.asarray(value).copy()
    zero_mask = (value == 0) | np.isinf(value) | np.isnan(value)
    value[zero_mask] = 1.0
    sign_mask = value < 0
    value[sign_mask] *= -1
    exponent = np.ceil(np.log10(value))
    result = 10**exponent * np.round(value * 10 ** (-exponent), N)
    result[sign_mask] *= -1
    result[zero_mask] = in_value[zero_mask]
    return result

# this may or may not be too specific
SIGNALS = ["pcr_conc_smoothed"]
DATES = ["issue", "date"]
METRIC_SIGNALS =["detect_prop_15d", "percentile", "ptc_15d"]
METRIC_DATES = ["issue", "date_start", "date_end"]
SAMPLE_SITE_NAMES = {"wwtp_jurisdiction" : "category", "wwtp_id" : int, "wwtp_id" : int, "reporting_jurisdiction" : "category", "sample_location" : "category", "county_names" : "category", "county_fips" : "category", "population_served" : float, "sampling_prior" : bool, "sample_location_specify" : float, }
KEY_NAMES = {"date" : "datetime64[ns]", "normalization" : "category"}
MAPPING_NAMES = ["wwtp_jurisdiction", "county_name", "county_fips"]
#+end_src

#+RESULTS:

So the county wwss mapping is... really messy, so for now I'm only going to do the state level.
And actually, I'm not sure there's any need for per-geo weighting at the state level.
So the unweighted doesn't need population counts, and its already listed in the key.
Would having a dictionary of key -> state pairs be faster than applying a map?
Probably not, almost entirely because of loading that table into memory.
** Implementing the state-level aggregations
The direct version is better (see below), but if we're also normalizing, that doesn't matter much, since we need the per-day values.
#+begin_src jupyter-python :session *nwss
sensor = "pcr_conc_smoothed"
df = pd.DataFrame.from_records(results)
df_metric = pd.DataFrame.from_records(results_metric)
df_metric.population_served = df_metric.population_served.astype("float", copy=False)
df.pcr_conc_smoothed = df.pcr_conc_smoothed.astype("float", copy=False)
# faster to add states directly from df beforehand
df["state"] = df.key_plot_id.str.extract(r"_(\w\w)_")
df_metric.rename(columns = {"date_start" : "date"}, inplace=True)
df_metric.set_index(["key_plot_id", "date"], inplace=True)#[["key_plot_id", "date_start" "population_served"]]
df.set_index(["key_plot_id","date"], inplace=True)
df = df.join(df_metric)
df.population_served.ffill(inplace = True)
df_metric.columns
df[f"weighted_{sensor}"] = df.pcr_conc_smoothed * df.population_served
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
#keys = pd.Series(df.key_plot_id.unique())
df[f"weighted_{sensor}"] = df.pcr_conc_smoothed * df.population_served
min(df.pcr_conc_smoothed.isna() * df.population_served)
# weighted_df = df.groupby("date").agg(
#     {"population_served": "sum", f"weighted_{sensor}": "sum"}
# )

# weighted_df["val"] = (
#     weighted_df[f"weighted_{sensor}"] / weighted_df.population_served
# )
# weighted_df
# grouped = df.groupby(["date","state"])
# weighted_sum = grouped.agg({"population_served" : "sum", "weighted" : "sum"})
# weighted_sum["pcr_conc_smoothed"] = weighted_sum.weighted / weighted_sum.population_served
# weighted_sum
#df.groupby(["state", "date"]).agg({"pcr_conc_smoothed" : "sum"})
#+end_src

#+RESULTS:
: 0.0

#+begin_src jupyter-python :session *nwss
df.transpose()
#+end_src

#+RESULTS:
#+begin_example
                                                              0       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-06-20
pcr_conc_smoothed                                     343671562.1219
normalization                                        flow-population

                                                              1       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-06-21
pcr_conc_smoothed                                     352803863.2000
normalization                                        flow-population

                                                              2       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-06-26
pcr_conc_smoothed                                     422806228.2508
normalization                                        flow-population

                                                              3       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-06-27
pcr_conc_smoothed                                     446172359.5670
normalization                                        flow-population

                                                              4       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-06-28
pcr_conc_smoothed                                     472180691.7122
normalization                                        flow-population

                                                              5       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-07-04
pcr_conc_smoothed                                     627255673.4934
normalization                                        flow-population

                                                              6       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-07-05
pcr_conc_smoothed                                     644164091.9416
normalization                                        flow-population

                                                              7       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-07-07
pcr_conc_smoothed                                     666989520.6371
normalization                                        flow-population

                                                              8       \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater
date                                                      2023-07-08
pcr_conc_smoothed                                     673126503.1953
normalization                                        flow-population

                                                              9       ...  \
key_plot_id        CDC_BIOBOT_ak_1158_Treatment plant_raw wastewater  ...
date                                                      2023-07-10  ...
pcr_conc_smoothed                                     663188507.2409  ...
normalization                                        flow-population  ...

                                                          708643  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-18
pcr_conc_smoothed                                         0.0007
normalization                                          microbial

                                                          708644  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-21
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708645  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-22
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708646  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-24
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708647  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-25
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708648  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-26
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708649  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-27
pcr_conc_smoothed                                            NaN
normalization                                          microbial

                                                          708650  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-28
pcr_conc_smoothed                                            NaN
normalization                                                NaN

                                                          708651  \
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-29
pcr_conc_smoothed                                            NaN
normalization                                                NaN

                                                          708652
key_plot_id        WWS_ut_1708_Treatment plant_post grit removal
date                                                  2023-11-30
pcr_conc_smoothed                                            NaN
normalization                                                NaN

[4 rows x 708653 columns]
#+end_example

*** Time comparison direct regex vs a dictionary
first we need to get the states; is this faster by directly using extract?
#+begin_src jupyter-python :session *nwss
df.transpose()
keys = pd.Series(df.key_plot_id.unique())
%timeit df["state"] = df.key_plot_id.str.extract(r"_(\w\w)_")
#df.key_plot_id.str.split("_")#.str[1]
#+end_src

#+RESULTS:
: 439 ms ± 31.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)

or with a dictionary?
#+begin_src jupyter-python :session *nwss
keys = pd.Series(df.key_plot_id.unique())
key_state_dict = {key: state for (key, state) in zip(keys.values, keys.str.extract(r"_(\w\w)_").values) }
3
#+begin_src jupyter-python :session *nwss
%timeit df["state"] = df.key_plot_id.map(key_state_dict)
#pd.DataFrame( state keys.str.extract(r"_(\w\w)_"))
#%timeit df.key_plot_id.str.extract(r"_(\w\w)_")
#df.key_plot_id.str.split("_")#.str[1]
#+end_src

#+RESULTS:
: 22.6 ms ± 673 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)

so a gain of... ~1 order of magnitude, maybe, but quite possibly worse. And requires adding to geomapper.
** Exact from pull.py
#+begin_src jupyter-python :session *nwss
import numpy as np
import pandas as pd
from sodapy import Socrata
NEWLINE = "\n"
SIGNALS = ["pcr_conc_smoothed"]
METRIC_SIGNALS = ["detect_prop_15d", "percentile", "ptc_15d"]
METRIC_DATES = ["date_start", "date_end"]
SAMPLE_SITE_NAMES = {
    "wwtp_jurisdiction": "category",
    "wwtp_id": int,
    "wwtp_id": int,
    "reporting_jurisdiction": "category",
    "sample_location": "category",
    "county_names": "category",
    "county_fips": "category",
    "population_served": float,
    "sampling_prior": bool,
    "sample_location_specify": float,
}
SIG_DIGITS = 7
def sig_digit_round(value, N):
    """round the number of significant digits (x.xxe5 would be 3) to `N`."""
    in_value = value
    value = np.asarray(value).copy()
    zero_mask = (value == 0) | np.isinf(value) | np.isnan(value)
    value[zero_mask] = 1.0
    sign_mask = value < 0
    value[sign_mask] *= -1
    exponent = np.ceil(np.log10(value))
    result = 10**exponent * np.round(value * 10 ** (-exponent), N)
    result[sign_mask] *= -1
    result[zero_mask] = in_value[zero_mask]
    return result
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
export_start_date = "2020-02-01"
daily_export_dir = "./daily_receiving"
keep_columns = SIGNALS.copy()
signals_dict_metric = {key: float for key in METRIC_SIGNALS}
metric_dates_dict = {key: "datetime64[ns]" for key in METRIC_DATES}
type_dict_metric = {**metric_dates_dict, **signals_dict_metric, **SAMPLE_SITE_NAMES}
# concentration key types
signals_dict = {key: float for key in SIGNALS}
type_dict = {**signals_dict}
type_dict["timestamp"] = "datetime64[ns]"
test_file = None
if test_file:
    df = pd.read_csv("./test_data/%s" % test_file)
else:
    # Pull data from Socrata API
    client = Socrata("data.cdc.gov", token)
    results_concentration = client.get("g653-rqe2", limit=10**10)
    results_metric = client.get("2ew6-ywp6", limit=10**10)
    df_metric = pd.DataFrame.from_records(results_metric)
    df = pd.DataFrame.from_records(results_concentration)
    df.rename(columns={"date": "timestamp"}, inplace=True)
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
def pull_nwss_data(token: str, test_file = None):
    """Pull the latest NWSS Wastewater data, and conforms it into a dataset.

    The output dataset has:

    - Each row corresponds to (sewershed_key, day), denoted (geo_id, timestamp)
    - Each row additionally has columns 'pcr_conc_smoothed', 'normalization',
    'population_served', 'ptc_15d', 'detect_prop_15d',

    Parameters
    ----------
    token: str
        My App Token for pulling the NWSS data (could be the same as the nchs data)
    test_file: Optional[str]
        When not null, name of file from which to read test data

    Returns
    -------
    pd.DataFrame
        Dataframe as described above.
    """
    # Constants
    keep_columns = SIGNALS.copy()
    signals_dict_metric = {key: float for key in METRIC_SIGNALS}
    metric_dates_dict = {key: "datetime64[ns]" for key in METRIC_DATES}
    type_dict_metric = {**metric_dates_dict, **signals_dict_metric, **SAMPLE_SITE_NAMES}
    # concentration key types
    signals_dict = {key: float for key in SIGNALS}
    type_dict = {**signals_dict}
    type_dict["timestamp"] = "datetime64[ns]"

    if test_file:
        df = pd.read_csv("./test_data/%s" % test_file)
    else:
        # Pull data from Socrata API
        client = Socrata("data.cdc.gov", token)
        results_concentration = client.get("g653-rqe2", limit=10**10)
        results_metric = client.get("2ew6-ywp6", limit=10**10)
        df_metric = pd.DataFrame.from_records(results_metric)
        df = pd.DataFrame.from_records(results_concentration)
        df.rename(columns={"date": "timestamp"}, inplace=True)
    try:
        df = df.astype(type_dict)
    except KeyError as exc:
        raise ValueError(
            f"""
Expected column(s) missed, The dataset schema may
have changed. Please investigate and amend the code.

Columns needed:
{NEWLINE.join(type_dict.keys())}

Columns available:
{NEWLINE.join(df.columns)}
"""
        ) from exc
    try:
        df_metric = df_metric.astype(type_dict_metric)
    except KeyError as exc:
        raise ValueError(
            f"""
Expected column(s) missed, The metric dataset schema may
have changed. Please investigate and amend the code.

Columns needed:
{NEWLINE.join(type_dict_metric.keys())}

Columns available:
{NEWLINE.join(df_metric.columns)}
"""
        ) from exc

    # pull 2 letter state labels out of the key_plot_id labels
    df["state"] = df.key_plot_id.str.extract(r"_(\w\w)_")

    # round out some of the numeric noise that comes from smoothing
    for signal in SIGNALS:
        df[signal] = sig_digit_round(df[signal], SIG_DIGITS)

    # drop unused columns from df_metric
    df_population = df_metric.loc[:, ["key_plot_id", "date_start", "population_served"]]
    # get matching keys
    df_population.rename(columns={"date_start": "timestamp"}, inplace=True)
    df_population.set_index(["key_plot_id", "timestamp"], inplace=True)
    df.set_index(["key_plot_id", "timestamp"], inplace=True)

    df = df.join(df_population)
    df.reset_index(inplace=True)
    # if there are population NA's, assume the previous value is accurate (most likely introduced by dates only present in one and not the other; even otherwise, best to assume some value rather than break the data)
    df.population_served.ffill(inplace=True)

    keep_columns.extend(["timestamp", "state", "population_served"])
    return df[keep_columns]
df_pull = pull_nwss_data(token)
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
def add_nancodes(df):
    """Add nancodes to the dataframe."""
    # Default missingness codes
    df["missing_val"] = Nans.NOT_MISSING
    df["missing_se"] = Nans.NOT_APPLICABLE
    df["missing_sample_size"] = Nans.NOT_APPLICABLE

    # Mark any remaining nans with unknown
    remaining_nans_mask = df["val"].isnull()
    df.loc[remaining_nans_mask, "missing_val"] = Nans.OTHER
    return df


def generate_weights(df, column_aggregating="pcr_conc_smoothed"):
    # set the weight of places with na's to zero
    df[f"relevant_pop_{column_aggregating}"] = (
        df["population_served"] * df[column_aggregating].notna()
    )
    # generate the weighted version
    df[f"weighted_{column_aggregating}"] = (
        df[column_aggregating] * df[f"relevant_pop_{column_aggregating}"]
    )
    return df


def add_needed_columns(df, col_names=["se", "sample_size"]):
    for col_name in col_names:
        df[col_name] = np.nan
    return df
GEOS = [
    "nation",
    "state",
    # "hrr",
    # "msa",
    # "hhs",
    # "county",
    # "wwss",  # wastewater sample site, name will probably need to change
]
#+end_src

#+RESULTS:

#+begin_src jupyter-python :session *nwss
start_date = min(df_pull["timestamp"])
## aggregate
sensor = SIGNALS[0]
geo = GEOS[1]
df = df_pull.copy()
# add weighed column
df = generate_weights(df, sensor)
if geo == "nation":
    agg_df = df.groupby("timestamp").agg(
        {"population_served": "sum", f"weighted_{sensor}": "sum"}
    )
    agg_df["val"] = agg_df[f"weighted_{sensor}"] / agg_df.population_served
    agg_df["geo_id"] = "us"
else:
    agg_df = df.groupby(["timestamp", geo]).agg(
        {"population_served": "sum", f"weighted_{sensor}": "sum"}
    )
    agg_df["val"] = agg_df[f"weighted_{sensor}"] / agg_df.population_served
    agg_df = agg_df.rename({"state": "geo_id"})
# add se, sample_size, and na codes
agg_df = add_needed_columns(agg_df)
agg_df = agg_df.reset_index()
agg_df.rename(columns={"state" : "geo_id"})
df[df.timestamp=="2020-04-22"]
## log this indicator run
#+end_src

#+RESULTS:
#+begin_example
        pcr_conc_smoothed  timestamp state  population_served  \
19921                 NaN 2020-04-22    az            88521.0
21849                 NaN 2020-04-22    az            64521.0
374520                NaN 2020-04-22    az            17280.0
375820                NaN 2020-04-22    az             9430.0
377777                NaN 2020-04-22    az             9848.0

        relevant_pop_pcr_conc_smoothed  weighted_pcr_conc_smoothed
19921                              0.0                         NaN
21849                              0.0                         NaN
374520                             0.0                         NaN
375820                             0.0                         NaN
377777                             0.0                         NaN
#+end_example

#+begin_src jupyter-python :session *nwss
agg_df
#+end_src

#+RESULTS:
#+begin_example
            population_served  weighted_pcr_conc_smoothed           val  se  \
timestamp
2020-04-22           189600.0                0.000000e+00  0.000000e+00 NaN
2020-04-23           189600.0                0.000000e+00  0.000000e+00 NaN
2020-04-24           243178.0                0.000000e+00  0.000000e+00 NaN
2020-04-25           249678.0                3.050359e+14  1.221717e+09 NaN
2020-04-26           249678.0                2.899780e+14  1.161408e+09 NaN
...                       ...                         ...           ...  ..
2023-12-01         79077142.0                3.163871e+03  4.000993e-05 NaN
2023-12-02         59565566.0                1.918134e+03  3.220206e-05 NaN
2023-12-03         51679655.0                0.000000e+00  0.000000e+00 NaN
2023-12-04         50814510.0                0.000000e+00  0.000000e+00 NaN
2023-12-05         50786982.0                0.000000e+00  0.000000e+00 NaN

            sample_size
timestamp
2020-04-22          NaN
2020-04-23          NaN
2020-04-24          NaN
2020-04-25          NaN
2020-04-26          NaN
...                 ...
2023-12-01          NaN
2023-12-02          NaN
2023-12-03          NaN
2023-12-04          NaN
2023-12-05          NaN

[1323 rows x 5 columns]
#+end_example

** Implementing a key_plot_id based table
#+begin_src jupyter-python :session *nwss
def create_weighted_wwss_county_state(data):
    """build 2 crosswalk tables: the first from wastewater sample sites to the county that they're in, and the second from wastewater sample sites to their states"""
    df_metric
key_plot_id_lookup = df_metric[["key_plot_id", "county_fips","population_served"]].drop_duplicates("key_plot_id", keep="last").astype({"population_served" : int})

# key_plot_id_lookup.set_index(["key_plot_id", "county_fips"], inplace = True)
# key_plot_id_lookup
# key_plot_id_lookup.groupby("county_fips", as_index=False).apply( lambda g: g["population_served"] / g["population_served"].sum())
#key_plot_id_lookup.county_fips.apply(lambda x: x.split(","))
key_plot_single_fips = key_plot_id_lookup.copy()
key_plot_single_fips["county_fips"] = key_plot_id_lookup.county_fips.apply(lambda x: x.split(","))

key_plot_single_fips["county_lengths"] = key_plot_single_fips.county_fips.apply(lambda x: len(x))
key_plot_single_fips.sort_values("county_lengths", inplace=True)
key_plot_single_fips = key_plot_single_fips.explode("county_fips")
key_plot_single_fips
#key_plot_single_fips.transpose()
#key_plot_single_fips.sort_values("county_len")
#+end_src

#+RESULTS:
#+begin_example
                                              key_plot_id county_fips  \
151     CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater       05069
503170         WWS_nj_1763_Treatment plant_primary sludge       34025
502816       WWS_in_772_Treatment plant_post grit removal       18105
502350         WWS_id_1672_Treatment plant_primary sludge       16055
501676        NWSS_pa_1529_Treatment plant_raw wastewater       42063
...                                                   ...         ...
506545        NWSS_va_1838_Treatment plant_raw wastewater       51685
506545        NWSS_va_1838_Treatment plant_raw wastewater       51683
506545        NWSS_va_1838_Treatment plant_raw wastewater       51107
506545        NWSS_va_1838_Treatment plant_raw wastewater       51153
506545        NWSS_va_1838_Treatment plant_raw wastewater       51059

        population_served  county_lengths
151                 42323               1
503170              52672               1
502816              56090               1
502350              50540               1
501676              28809               1
...                   ...             ...
506545             350000               7
506545             350000               7
506545             350000               7
506545             350000               7
506545             350000               7

[1943 rows x 4 columns]
#+end_example

#+begin_src jupyter-python :session *nwss
key_plot_single_fips[key_plot_single_fips.county_fips == "51059"]
#+end_src

#+RESULTS:
#+begin_example
                                           key_plot_id county_fips  \
220161    NWSS_va_38_Treatment plant_post grit removal       51059
463226     NWSS_va_1827_Treatment plant_raw wastewater       51059
510944    WWS_dc_486_Treatment plant_post grit removal       51059
118583  NWSS_va_2078_Treatment plant_post grit removal       51059
506545     NWSS_va_1838_Treatment plant_raw wastewater       51059

        population_served  county_lengths
220161             300000               2
463226             165901               2
510944            2000000               4
118583             232965               4
506545             350000               7
#+end_example

51153
#+RESULTS:
:                                          key_plot_id county_fips  \
: 463226   NWSS_va_1827_Treatment plant_raw wastewater       51153
: 417072  NWSS_va_42_Treatment plant_post grit removal       51153
: 506545   NWSS_va_1838_Treatment plant_raw wastewater       51153
:
:         population_served  county_lengths
: 463226             165901               2
: 417072              92000               2
: 506545             350000               7

NWSS_va_1827_Treatment plant_raw wastewater
#+RESULTS:
:                                         key_plot_id county_fips  \
: 463226  NWSS_va_1827_Treatment plant_raw wastewater       51153
: 463226  NWSS_va_1827_Treatment plant_raw wastewater       51059
:
:         population_served  county_lengths
: 463226             165901               2
: 463226             165901               2

51059,1150847
#+begin_src jupyter-python :session *nwss
type_dict = {"pcr_conc_smoothed" : float, "issue" : "datetime64[ns]", "date" : "datetime64[ns]"}
# TODO figure out whether we should be using the start, end or mid date
metric_dates_dict = {key : "datetime64[ns]" for key in DATES_METRIC}
metric_signals_dict = {key : float for key in METRIC_SIGNALS}
metric_type_dict = {**metric_dates_dict, **metric_signals_dict, **SAMPLE_SITE_NAMES}

df["issue"] = pd.Timestamp("now")
df_metric["issue"] = pd.Timestamp("now")
#+end_src

#+RESULTS:


#+begin_src jupyter-python :session *nwss
df_metric
#+end_src

#+RESULTS:
: Index(['wwtp_jurisdiction', 'wwtp_id', 'reporting_jurisdiction',
:        'sample_location', 'key_plot_id', 'county_names', 'county_fips',
:        'population_served', 'date_start', 'date_end', 'detect_prop_15d',
:        'percentile', 'sampling_prior', 'first_sample_date', 'ptc_15d',
:        'sample_location_specify', 'issue'],
:       dtype='object')

#+begin_src jupyter-python :session *nwss
df_metric
sample_site_col_names = ["key_plot_id"] + list(SAMPLE_SITE_NAMES.keys())
key_plot_id_lookup = df_metric[sample_site_col_names].drop_duplicates()#.set_index(sample_site_col_names).index.unique()
key_plot_id_lookup.set_index("key_plot_id", inplace = True)
key_plot_id_lookup
#[len(df["key_plot_id"].unique()),len(df_metric["key_plot_id"].unique())]
# df = df.astype(type_dict)
# df["pcr_conc_smoothed"] = sig_digit_round(df["pcr_conc_smoothed"], 7)
# df_metric["population_served"]
# df.set_index(["key_plot_id", "date"], inplace=True)
# df_metric.transpose()
# df_metric.sample_location_specify.sort_values()
#df.join(df_metric, on = ["key_plot_id"])
#df_metric["key_plot_id"]
#+end_src

#+RESULTS:
#+begin_example
                                                   wwtp_jurisdiction wwtp_id  \
key_plot_id
CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater           Arkansas    1548
CDC_BIOBOT_in_1162_Treatment plant_raw wastewater            Indiana    1162
NWSS_il_675_Before treatment plant_21_raw waste...          Illinois     675
NWSS_ma_2471_Before treatment plant_595_raw was...     Massachusetts    2471
NWSS_mi_1086_Treatment plant_raw wastewater                 Michigan    1086
...                                                              ...     ...
NWSS_il_631_Treatment plant_raw wastewater                  Illinois     631
NWSS_mi_1048_Treatment plant_raw wastewater                 Michigan    1048
NWSS_ny_1404_Treatment plant_raw wastewater                 New York    1404
NWSS_wa_2105_Treatment plant_raw wastewater               Washington    2105
WWS_ca_1703_Treatment plant_post grit removal             California    1703

                                                   sampling_prior  \
key_plot_id
CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater              no
CDC_BIOBOT_in_1162_Treatment plant_raw wastewater              no
NWSS_il_675_Before treatment plant_21_raw waste...             no
NWSS_ma_2471_Before treatment plant_595_raw was...             no
NWSS_mi_1086_Treatment plant_raw wastewater                    no
...                                                           ...
NWSS_il_631_Treatment plant_raw wastewater                     no
NWSS_mi_1048_Treatment plant_raw wastewater                    no
NWSS_ny_1404_Treatment plant_raw wastewater                    no
NWSS_wa_2105_Treatment plant_raw wastewater                    no
WWS_ca_1703_Treatment plant_post grit removal                  no

                                                   sample_location_specify
key_plot_id
CDC_BIOBOT_ar_1548_Treatment plant_raw wastewater                      NaN
CDC_BIOBOT_in_1162_Treatment plant_raw wastewater                      NaN
NWSS_il_675_Before treatment plant_21_raw waste...                      21
NWSS_ma_2471_Before treatment plant_595_raw was...                     595
NWSS_mi_1086_Treatment plant_raw wastewater                            NaN
...                                                                    ...
NWSS_il_631_Treatment plant_raw wastewater                             NaN
NWSS_mi_1048_Treatment plant_raw wastewater                            NaN
NWSS_ny_1404_Treatment plant_raw wastewater                            NaN
NWSS_wa_2105_Treatment plant_raw wastewater                            NaN
WWS_ca_1703_Treatment plant_post grit removal                          NaN

[1729 rows x 4 columns]
#+end_example

#+begin_src jupyter-python :session *nwss
df = df.astype(type_dict)
df_metric = df_metric.astype(metric_type_dict)
df_metric
df_metric.set_index(["key_plot_id", "date_start", "issue"], inplace=True)
df.set_index(["key_plot_id", "date", "issue"], inplace=True)
#+end_src

#+RESULTS:
** Are the populations the same on a per-county basis and a per-wwss basis?
#+begin_src jupyter-python :session *nwss
key_plot_id_lookup["population_served"].sum()
#+end_src

#+RESULTS:
: 206036077

#+begin_src jupyter-python :session *nwss
fips_pop = pd.read_csv("../_delphi_utils_python/delphi_utils/data/2020/fips_pop.csv")
fips_pop["pop"].sum()
#+end_src

#+RESULTS:
: 334103109
** wwss -> fips mapping
So this is a tricky problem, since it's a many to many relationship.
We can think of it as finding a sparse matrix $A$ so that $Ax = y$, where $x$ is the population values in a given county, and $y$ is the population in a given catchment area.

This is a kind of matrix completion, with the restriction that 
